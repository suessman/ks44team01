<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="anypet.ks44team01.mapper.GoodsMapperOsj">
		<resultMap type="GoodsLargeCategory" id="goodsResultMap">
		<id 	column="category_code"				property="categoryCode"/>
		<result column="category_name"				property="categoryName"/>
		<result column="registration_datetime"		property="registrationDatetime"/>
		<result column="id"							property="Id"/>
		</resultMap>
		
		<!-- 대분류목록조회 -->
		<select id="getGoodsLargeCategoryList" resultMap="goodsResultMap" fetchSize="100">
			/* 대분류목록조회 */
			SELECT 
				category_code, 
				category_name,
				id,
				registration_datetime
			FROM 
				company_category;
		</select>
		
		<!-- 대분류등록 -->
		<insert id="goodsLargeCategoryInsert" parameterType="GoodsLargeCategory">
		<selectKey keyProperty="categoryCode" resultType="String" order="BEFORE">
			SELECT
				(CASE 
				 -- 상품이 없을 경우
				 WHEN count(cc.category_code) = 0 THEN 'cc001'
				 -- 999개 등록되어 있을 경우
				 WHEN (Max(CAST(substring_index(cc.category_code,'cc',-1) AS UNSIGNED))+1) > 999 THEN
				 	concat('cc',Max(CAST(substring_index(cc.category_code,'cc',-1) AS UNSIGNED))+1)
				 -- 1~999 범위일 경우
				 ELSE
					concat('cc',LPAD(Max(CAST(substring_index(cc.category_code,'cc',-1) AS UNSIGNED))+1,3,0))	
				 END) AS goodsCode
			FROM 
				company_category AS cc;
		</selectKey>
			INSERT INTO company_category
			(category_code,
			 category_name,
			 registration_datetime,
			 id)
			VALUES (
				 #{categoryCode}
			 	,#{categoryName}
			 	,Now()
			  	,#{Id}
			   );
		</insert>
		
	<!-- 대분류 수정 -->
	<update id="goodsLargeCategoryModify" parameterType="GoodsLargeCategory">
		UPDATE company_category
		<trim prefix="SET" prefixOverrides=",">		
			<if test="categoryName != null and categoryName != ''">
			    category_name       	= #{categoryName}
			</if>
			<if test="Id != null and Id != ''">
			   ,id     					= #{Id}
			</if>
			   ,registration_datetime    = now()
			
		</trim>
		WHERE
		   category_code = #{categoryCode};
	</update>

	<!-- 특정대분류조회 -->
	<select id="getLargeCategoryInfoByCategoryCode" parameterType="String" resultType="GoodsLargeCategory">
		/* 특정대분류조회 */
		SELECT 
			 cc.category_code					AS		categoryCode
			,cc.category_name					AS		categoryName
			,cc.id								AS		Id
			,cc.registration_datetime			AS		registrationDatetime
		FROM 
			company_category AS cc
		WHERE
			cc.category_code = #{categoryCode}
	</select>
	
	<!-- 중분류 수정 -->
	<update id="goodsMediumCategoryModify" parameterType="GoodsMediumCategory">
		UPDATE company_category_sub
		<trim prefix="SET" prefixOverrides=",">	
			<if test="categoryCode != null and categoryCode != ''">
			    category_code      			= #{categoryCode}
			</if>	
			<if test="categoryNameSub != null and categoryNameSub != ''">
			   ,category_sub_name       	= #{categoryNameSub}
			</if>
			<if test="Id != null and Id != ''">
			   ,id     						= #{Id}
			</if>
			   ,registration_datetime 		= now()
		</trim>
		WHERE
		   category_code_sub = #{categoryCodeSub};
	</update>

	<!-- 특정중분류조회 -->
	<select id="getMediumCategoryInfoByCategoryCodeSub" parameterType="String" resultType="GoodsMediumCategory">
		/* 특정중분류조회 */
		SELECT 
			 ccs.category_code_sub				AS		categoryCodeSub
			,ccs.category_code					AS		categoryCode
			,ccs.category_sub_name				AS		categoryNameSub
			,ccs.id								AS		Id
			,ccs.registration_datetime			AS		registrationDatetime
		FROM 
			company_category_sub AS ccs
		WHERE
			ccs.category_code_sub = #{categoryCodeSub}
	</select>

	<!-- 중분류목록조회 -->
	<select id="getGoodsMediumCategoryList" resultType="GoodsMediumCategory">
		/* 중분류목록조회 */
		SELECT 
			category_code_sub				as		categoryCodeSub
			,category_code                  as		categoryCode
			,category_sub_name				as		categoryNameSub
			,id								as		Id
			,registration_datetime			as		registrationDatetime
		FROM 
			company_category_sub;
	</select>
		
		
		<!-- 중분류등록 -->
		<insert id="goodsMediumCategoryInsert" parameterType="GoodsMediumCategory">
		<selectKey keyProperty="categoryCodeSub" resultType="String" order="BEFORE">
			SELECT
				(CASE 
				 -- 상품이 없을 경우
				 WHEN count(ccs.category_code_sub) = 0 THEN 'ccs001'
				 -- 999개 등록되어 있을 경우
				 WHEN (Max(CAST(substring_index(ccs.category_code_sub,'ccs',-1) AS UNSIGNED))+1) > 999 THEN
				 	concat('ccs',Max(CAST(substring_index(ccs.category_code_sub,'ccs',-1) AS UNSIGNED))+1)
				 -- 1~999 범위일 경우
				 ELSE
					concat('ccs',LPAD(Max(CAST(substring_index(ccs.category_code_sub,'ccs',-1) AS UNSIGNED))+1,3,0))	
				 END) AS goodsCode
			FROM 
				company_category_sub AS ccs;
		</selectKey>
			INSERT INTO company_category_sub
			(category_code_sub,
			 category_code,
			 id,
			 category_sub_name,
			 registration_datetime
			 )
			VALUES (
				 #{categoryCodeSub}
				,#{categoryCode}
			  	,#{Id}
			 	,#{categoryNameSub}
			 	,Now()
			   );
		</insert>

		

		
		
</mapper>